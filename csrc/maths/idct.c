#include "idct.h"

const float w[] = {
     1.00000000e+00,  // cos( 0 * pi / 16)
     9.80785280e-01,  // cos( 1 * pi / 16)
     9.23879533e-01,  // cos( 2 * pi / 16)
     8.31469612e-01,  // cos( 3 * pi / 16)
     7.07106781e-01,  // cos( 4 * pi / 16)
     5.55570233e-01,  // cos( 5 * pi / 16)
     3.82683432e-01,  // cos( 6 * pi / 16)
     1.95090322e-01,  // cos( 7 * pi / 16)
     0.000000000+00,  // cos( 8 * pi / 16)
    -1.95090322e-01,  // cos( 9 * pi / 16)
    -3.82683432e-01,  // cos(10 * pi / 16)
    -5.55570233e-01,  // cos(11 * pi / 16)
    -7.07106781e-01,  // cos(12 * pi / 16)
    -8.31469612e-01,  // cos(13 * pi / 16)
    -9.23879533e-01,  // cos(14 * pi / 16)
    -9.80785280e-01,  // cos(15 * pi / 16)
    -1.00000000e+00,  // cos(16 * pi / 16)
    -9.80785280e-01,  // cos(17 * pi / 16)
    -9.23879533e-01,  // cos(18 * pi / 16)
    -8.31469612e-01,  // cos(19 * pi / 16)
    -7.07106781e-01,  // cos(20 * pi / 16)
    -5.55570233e-01,  // cos(21 * pi / 16)
    -3.82683432e-01,  // cos(22 * pi / 16)
    -1.95090322e-01,  // cos(23 * pi / 16)
     0.000000000+00,  // cos(24 * pi / 16)
     1.95090322e-01,  // cos(25 * pi / 16)
     3.82683432e-01,  // cos(26 * pi / 16)
     5.55570233e-01,  // cos(27 * pi / 16)
     7.07106781e-01,  // cos(28 * pi / 16)
     8.31469612e-01,  // cos(29 * pi / 16)
     9.23879533e-01,  // cos(30 * pi / 16)
     9.80785280e-01,  // cos(31 * pi / 16)
};


const float r2 = 7.07106781e-01; // 1 / sqrt(2)

void idct2(const int16_t inp[64], float out[64]) {
    for (int x = 0; x < 8; x++) {
        for (int y = 0; y < 8; y++) {
            float val = 128;
            for (int u = 0; u < 8; u++) {
                for (int v = 0; v < 8; v++) {
                    float cu = u == 0 ? r2 : 1, cv = v == 0 ? r2 : 1;
                    float cosu = w[((2 * x + 1) * u) % 32];
                    float cosv = w[((2 * y + 1) * v) % 32];
                    int16_t svu = inp[8 * v + u];
                    float yxvu = 0.25 * cu * cv * svu * cosu * cosv;
                    val += (int16_t) yxvu;
                }
            }
            val = val > 255 ? 255 : val;
            val = val < 0 ? 0 : val;
            out[8 * y + x] = val;
        }
    }
}
